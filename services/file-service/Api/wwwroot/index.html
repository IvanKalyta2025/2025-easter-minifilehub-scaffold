<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jobbmarked - Min Profil</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="card" id="mainCard">
        <div id="login" class="form-section active">
          <h2>Velkommen tilbake</h2>
          <form onsubmit="handleAuth(event, '/Auth/login', 'login')">
            <div class="input-group">
              <label>E-postadresse</label>
              <input
                type="email"
                name="email"
                required
                placeholder="din@epost.no"
              />
            </div>
            <div class="input-group">
              <label>Passord</label>
              <input type="password" name="password" required />
            </div>
            <button type="submit" class="primary-btn">Logg inn</button>
          </form>
          <div class="toggle-links">
            <p>
              Ny bruker?
              <span class="link" onclick="showSection('register')"
                >Opprett konto</span
              >
            </p>
          </div>
        </div>

        <div id="register" class="form-section">
          <h2>Opprett konto</h2>
          <form onsubmit="handleAuth(event, '/Auth/register', 'register')">
            <div class="input-group">
              <label>E-postadresse</label>
              <input type="email" name="email" required />
            </div>
            <div class="input-group">
              <label>Passord</label>
              <input type="password" name="password" required />
            </div>
            <button type="submit" class="primary-btn">Registrer deg</button>
          </form>
          <div class="toggle-links">
            <p>
              Har du уже konto?
              <span class="link" onclick="showSection('login')">Logg inn</span>
            </p>
          </div>
        </div>

        <div id="profile-view" class="form-section">
          <div class="profile-header">
            <img
              id="view-avatar"
              src="default-avatar.png"
              alt="Avatar"
              class="avatar-large"
            />
            <h2 id="view-fullname">Laster...</h2>
          </div>
          <div class="profile-actions">
            <button class="secondary-btn" onclick="showSection('profile-edit')">
              Rediger profil
            </button>
            <button class="outline-btn" onclick="logout()">Logg ut</button>
          </div>
        </div>

        <div id="profile-edit" class="form-section">
          <h2>Rediger profil</h2>
          <form onsubmit="handleProfileUpdate(event)">
            <div class="input-group">
              <label>Fornavn</label>
              <input type="text" name="FirstName" id="edit-firstname" />
            </div>
            <div class="input-group">
              <label>Etternavn</label>
              <input type="text" name="LastName" id="edit-lastname" />
            </div>
            <div class="input-group">
              <label>Profilbilde</label>
              <input type="file" name="Avatar" accept="image/*" />
            </div>
            <div class="button-row">
              <button type="submit" class="primary-btn">Lagre profil</button>
              <button
                type="button"
                class="outline-btn"
                onclick="showSection('profile-view')"
              >
                Avbryt
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      function showSection(id) {
        document
          .querySelectorAll(".form-section")
          .forEach((s) => s.classList.remove("active"));
        const target = document.getElementById(id);
        if (target) target.classList.add("active");
      }

      async function handleAuth(event, url, type) {
        event.preventDefault();
        const data = Object.fromEntries(new FormData(event.target).entries());

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            if (type === "register") {
              alert("Bruker opprettet! Logg inn nå.");
              showSection("login");
              return;
            }

            const result = await response.json();
            const token = result.token || result.Token;

            if (token) {
              localStorage.setItem("token", token);
              await loadProfileData();
            }
          } else {
            const errorText = await response.text();
            alert("Feil: " + errorText);
          }
        } catch (e) {
          console.error(e);
          alert("Serverfeil или проблема с JSON");
        }
      }

      async function loadProfileData() {
        const token = localStorage.getItem("token");
        if (!token) {
          showSection("login");
          return;
        }

        try {
          const response = await fetch("/api/Profile", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const profile = await response.json();
            document.getElementById("view-fullname").innerText =
              `${profile.firstName || ""} ${profile.lastName || ""}`.trim() ||
              "Navn ikke satt";
            document.getElementById("view-avatar").src =
              profile.avatarUrl || "default-avatar.png";

            document.getElementById("edit-firstname").value =
              profile.firstName || "";
            document.getElementById("edit-lastname").value =
              profile.lastName || "";

            showSection("profile-view");
          } else if (response.status === 404) {
            showSection("profile-edit");
          } else {
            logout();
          }
        } catch (error) {
          console.error(error);
          showSection("profile-edit");
        }
      }

      async function handleProfileUpdate(event) {
        event.preventDefault();
        const token = localStorage.getItem("token");
        const formData = new FormData(event.target);
        const btn = event.target.querySelector("button");
        btn.innerText = "Lagrer...";

        try {
          const response = await fetch("/api/Profile", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (response.ok) {
            await loadProfileData();
          } else {
            alert("Kunne ikke lagre profil.");
          }
        } catch (error) {
          alert("Serverfeil.");
        } finally {
          btn.innerText = "Lagre profil";
        }
      }

      function logout() {
        localStorage.removeItem("token");
        showSection("login");
      }

      window.onload = () => {
        if (localStorage.getItem("token")) loadProfileData();
      };
    </script>
  </body>
</html>
